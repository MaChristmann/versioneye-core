class SecurityVulnerability < Versioneye::Model

  include Mongoid::Document
  include Mongoid::Timestamps

  # Belongs to the product with this attributes
  field :language, type: String
  field :prod_key, type: String

  field :name_id       , type: String # Uniq. identifier
  field :author        , type: String
  field :summary       , type: String # The summary/title of the security vulnerability
  field :description   , type: String # Description. Might be Markdown.
  field :platform      , type: String
  field :osvdb         , type: String
  field :cve           , type: String # CVE = Common Vulnerabilities and Exposures - https://cve.mitre.org/
  field :cvss_v2       , type: String # The CVSSv2 score for the vulnerability. See: https://www.first.org/cvss/specification-document
  field :publish_date  , type: String
  field :framework     , type: String

  field :affected_versions_string, type: String
  field :affected_versions, type: Array, default: []

  field :patched_versions_string, type: String
  field :unaffected_versions_string, type: String

  field :links, type: Hash, default: {}

  field :approved, type: Boolean, default: true

  # db.security_vulnerabilities.dropIndex( {"language": 1, "prod_key": 1, "summary": 1} )
  # index({ language: 1, prod_key: 1}, { name: "lang_prod_key_index", background: true, unique: true, drop_dups: true })
  # index({ language: 1, prod_key: 1, :name_id}, { name: "lang_prod_key_nameid_index", background: true, unique: true, drop_dups: true })

  scope :by_language   , ->(lang){where(language: lang)}
  scope :by_prod_key   , ->(prod_key){where(prod_key: prod_key)}

  def product
    Product.fetch_product language, prod_key
  end

end
